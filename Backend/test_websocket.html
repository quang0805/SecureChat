<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Chat Test</title>
</head>
<body>
    <h1>WebSocket Chat Test</h1>
    <div>
        <label for="token">JWT Token:</label>
        <input type="text" id="token" placeholder="Paste your JWT token here" size="100">
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()" disabled>Disconnect</button>
    </div>
    <hr>
    <h2>Messages Received:</h2>
    <ul id="messages"></ul>

    <script>
        let ws;
        const messagesList = document.getElementById('messages');
        const tokenInput = document.getElementById('token');
        const connectButton = document.querySelector('button[onclick="connect()"]');
        const disconnectButton = document.querySelector('button[onclick="disconnect()"]');

        function connect() {
            const token = tokenInput.value;
            if (!token) {
                alert('Please paste a JWT token first!');
                return;
            }

            // Thay đổi `ws://localhost:8000` nếu server của bạn chạy ở địa chỉ khác
            ws = new WebSocket(`ws://localhost:8000/ws/${token}`);

            ws.onopen = function(event) {
                const li = document.createElement('li');
                li.textContent = '--- Connected to WebSocket server ---';
                li.style.color = 'green';
                messagesList.appendChild(li);
                connectButton.disabled = true;
                disconnectButton.disabled = false;
            };

            ws.onmessage = function(event) {
                console.log("Message from server ", event.data);
                const li = document.createElement('li');
                const messageData = JSON.parse(event.data);

                if (messageData.type === 'new_message') {
                    const payload = messageData.payload;
                    li.innerHTML = `<b>${payload.sender.username}:</b> ${payload.content}`;
                } else {
                    li.textContent = event.data;
                }
                messagesList.appendChild(li);
            };

            ws.onclose = function(event) {
                const li = document.createElement('li');
                li.textContent = '--- Disconnected from WebSocket server ---';
                li.style.color = 'red';
                messagesList.appendChild(li);
                connectButton.disabled = false;
                disconnectButton.disabled = true;
            };

            ws.onerror = function(error) {
                alert(`WebSocket Error: ${error.message}`);
                console.error('WebSocket Error: ', error);
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
            }
        }
    </script>
</body>
</html>